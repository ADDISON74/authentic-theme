(function(b){if(typeof exports=="object"&&typeof module=="object"){b(require("../../lib/codemirror"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror"],b)}else{b(CodeMirror)}}})(function(v){var t={addition:"positive",attributes:"attribute",bold:"strong",cite:"keyword",code:"atom",definitionList:"number",deletion:"negative",div:"punctuation",em:"em",footnote:"variable",footCite:"qualifier",header:"header",html:"comment",image:"string",italic:"em",link:"link",linkDefinition:"link",list1:"variable-2",list2:"variable-3",list3:"keyword",notextile:"string-2",pre:"operator",p:"property",quote:"bracket",span:"quote",specialChar:"tag",strong:"strong",sub:"builtin",sup:"builtin",table:"variable-3",tableHeading:"operator"};function n(a,b){b.mode=o.newLayout;b.tableHeading=false;if(b.layoutType==="definitionList"&&b.spanningLayout&&a.match(u("definitionListEnd"),false)){b.spanningLayout=false}}function x(a,b,c){if(c==="_"){if(a.eat("_")){return z(a,b,"italic",/__/,2)}else{return z(a,b,"em",/_/,1)}}if(c==="*"){if(a.eat("*")){return z(a,b,"bold",/\*\*/,2)}return z(a,b,"strong",/\*/,1)}if(c==="["){if(a.match(/\d+\]/)){b.footCite=true}return y(b)}if(c==="("){var e=a.match(/^(r|tm|c)\)/);if(e){return q(b,t.specialChar)}}if(c==="<"&&a.match(/(\w+)[^>]+>[^<]+<\/\1>/)){return q(b,t.html)}if(c==="?"&&a.eat("?")){return z(a,b,"cite",/\?\?/,2)}if(c==="="&&a.eat("=")){return z(a,b,"notextile",/==/,2)}if(c==="-"&&!a.eat("-")){return z(a,b,"deletion",/-/,1)}if(c==="+"){return z(a,b,"addition",/\+/,1)}if(c==="~"){return z(a,b,"sub",/~/,1)}if(c==="^"){return z(a,b,"sup",/\^/,1)}if(c==="%"){return z(a,b,"span",/%/,1)}if(c==="@"){return z(a,b,"code",/@/,1)}if(c==="!"){var d=z(a,b,"image",/(?:\([^\)]+\))?!/,1);a.match(/^:\S+/);return d}return y(b)}function z(a,c,g,b,h){var e=a.pos>h?a.string.charAt(a.pos-h-1):null;var f=a.peek();if(c[g]){if((!f||/\W/.test(f))&&e&&/\S/.test(e)){var d=y(c);c[g]=false;return d}}else{if((!e||/\W/.test(e))&&f&&/\S/.test(f)&&a.match(new RegExp("^.*\\S"+b.source+"(?:\\W|$)"),false)){c[g]=true;c.mode=o.attributes}}return y(c)}function y(a){var c=s(a);if(c){return c}var b=[];if(a.layoutType){b.push(t[a.layoutType])}b=b.concat(r(a,"addition","bold","cite","code","deletion","em","footCite","image","italic","link","span","strong","sub","sup","table","tableHeading"));if(a.layoutType==="header"){b.push(t.header+"-"+a.header)}return b.length?b.join(" "):null}function s(a){var b=a.layoutType;switch(b){case"notextile":case"code":case"pre":return t[b];default:if(a.notextile){return t.notextile+(b?(" "+t[b]):"")}return null}}function q(a,b){var c=s(a);if(c){return c}var d=y(a);if(b){return d?(d+" "+b):b}else{return d}}function r(a){var b=[];for(var c=1;c<arguments.length;++c){if(a[arguments[c]]){b.push(t[arguments[c]])}}return b}function w(b){var a=b.spanningLayout,c=b.layoutType;for(var d in b){if(b.hasOwnProperty(d)){delete b[d]}}b.mode=o.newLayout;if(a){b.layoutType=c;b.spanningLayout=true}}var p={cache:{},single:{bc:"bc",bq:"bq",definitionList:/- .*?:=+/,definitionListEnd:/.*=:\s*$/,div:"div",drawTable:/\|.*\|/,foot:/fn\d+/,header:/h[1-6]/,html:/\s*<(?:\/)?(\w+)(?:[^>]+)?>(?:[^<]+<\/\1>)?/,link:/[^"]+":\S/,linkDefinition:/\[[^\s\]]+\]\S+/,list:/(?:#+|\*+)/,notextile:"notextile",para:"p",pre:"pre",table:"table",tableCellAttributes:/[\/\\]\d+/,tableHeading:/\|_\./,tableText:/[^"_\*\[\(\?\+~\^%@|-]+/,text:/[^!"_=\*\[\(<\?\+~\^%@-]+/},attributes:{align:/(?:<>|<|>|=)/,selector:/\([^\(][^\)]+\)/,lang:/\[[^\[\]]+\]/,pad:/(?:\(+|\)+){1,2}/,css:/\{[^\}]+\}/},createRe:function(a){switch(a){case"drawTable":return p.makeRe("^",p.single.drawTable,"$");case"html":return p.makeRe("^",p.single.html,"(?:",p.single.html,")*","$");case"linkDefinition":return p.makeRe("^",p.single.linkDefinition,"$");case"listLayout":return p.makeRe("^",p.single.list,u("allAttributes"),"*\\s+");case"tableCellAttributes":return p.makeRe("^",p.choiceRe(p.single.tableCellAttributes,u("allAttributes")),"+\\.");case"type":return p.makeRe("^",u("allTypes"));case"typeLayout":return p.makeRe("^",u("allTypes"),u("allAttributes"),"*\\.\\.?","(\\s+|$)");case"attributes":return p.makeRe("^",u("allAttributes"),"+");case"allTypes":return p.choiceRe(p.single.div,p.single.foot,p.single.header,p.single.bc,p.single.bq,p.single.notextile,p.single.pre,p.single.table,p.single.para);case"allAttributes":return p.choiceRe(p.attributes.selector,p.attributes.css,p.attributes.lang,p.attributes.align,p.attributes.pad);default:return p.makeRe("^",p.single[a])}},makeRe:function(){var a="";for(var b=0;b<arguments.length;++b){var c=arguments[b];a+=(typeof c==="string")?c:c.source}return new RegExp(a)},choiceRe:function(){var a=[arguments[0]];for(var b=1;b<arguments.length;++b){a[b*2-1]="|";a[b*2]=arguments[b]}a.unshift("(?:");a.push(")");return p.makeRe.apply(null,a)}};function u(a){return(p.cache[a]||(p.cache[a]=p.createRe(a)))}var o={newLayout:function(a,b){if(a.match(u("typeLayout"),false)){b.spanningLayout=false;return(b.mode=o.blockType)(a,b)}var c;if(!s(b)){if(a.match(u("listLayout"),false)){c=o.list}else{if(a.match(u("drawTable"),false)){c=o.table}else{if(a.match(u("linkDefinition"),false)){c=o.linkDefinition}else{if(a.match(u("definitionList"))){c=o.definitionList}else{if(a.match(u("html"),false)){c=o.html}}}}}}return(b.mode=(c||o.text))(a,b)},blockType:function(a,b){var d,c;b.layoutType=null;if(d=a.match(u("type"))){c=d[0]}else{return(b.mode=o.text)(a,b)}if(d=c.match(u("header"))){b.layoutType="header";b.header=parseInt(d[0][1])}else{if(c.match(u("bq"))){b.layoutType="quote"}else{if(c.match(u("bc"))){b.layoutType="code"}else{if(c.match(u("foot"))){b.layoutType="footnote"}else{if(c.match(u("notextile"))){b.layoutType="notextile"}else{if(c.match(u("pre"))){b.layoutType="pre"}else{if(c.match(u("div"))){b.layoutType="div"}else{if(c.match(u("table"))){b.layoutType="table"}}}}}}}}b.mode=o.attributes;return y(b)},text:function(a,b){if(a.match(u("text"))){return y(b)}var c=a.next();if(c==='"'){return(b.mode=o.link)(a,b)}return x(a,b,c)},attributes:function(a,b){b.mode=o.layoutLength;if(a.match(u("attributes"))){return q(b,t.attributes)}else{return y(b)}},layoutLength:function(a,b){if(a.eat(".")&&a.eat(".")){b.spanningLayout=true}b.mode=o.text;return y(b)},list:function(a,b){var d=a.match(u("list"));b.listDepth=d[0].length;var c=(b.listDepth-1)%3;if(!c){b.layoutType="list1"}else{if(c===1){b.layoutType="list2"}else{b.layoutType="list3"}}b.mode=o.attributes;return y(b)},link:function(a,b){b.mode=o.text;if(a.match(u("link"))){a.match(/\S+/);return q(b,t.link)}return y(b)},linkDefinition:function(a,b){a.skipToEnd();return q(b,t.linkDefinition)},definitionList:function(a,b){a.match(u("definitionList"));b.layoutType="definitionList";if(a.match(/\s*$/)){b.spanningLayout=true}else{b.mode=o.attributes}return y(b)},html:function(a,b){a.skipToEnd();return q(b,t.html)},table:function(a,b){b.layoutType="table";return(b.mode=o.tableCell)(a,b)},tableCell:function(a,b){if(a.match(u("tableHeading"))){b.tableHeading=true}else{a.eat("|")}b.mode=o.tableCellAttributes;return y(b)},tableCellAttributes:function(a,b){b.mode=o.tableText;if(a.match(u("tableCellAttributes"))){return q(b,t.attributes)}else{return y(b)}},tableText:function(a,b){if(a.match(u("tableText"))){return y(b)}if(a.peek()==="|"){b.mode=o.tableCell;return y(b)}return x(a,b,a.next())}};v.defineMode("textile",function(){return{startState:function(){return{mode:o.newLayout}},token:function(a,b){if(a.sol()){n(a,b)}return b.mode(a,b)},blankLine:w}});v.defineMIME("text/x-textile","textile")});