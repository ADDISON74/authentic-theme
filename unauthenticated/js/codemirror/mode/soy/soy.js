(function(b){if(typeof exports=="object"&&typeof module=="object"){b(require("../../lib/codemirror"),require("../htmlmixed/htmlmixed"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror","../htmlmixed/htmlmixed"],b)}else{b(CodeMirror)}}})(function(d){var c=["template","literal","msg","fallbackmsg","let","if","elseif","else","switch","case","default","foreach","ifempty","for","call","param","deltemplate","delcall","log"];d.defineMode("soy",function(o){var l=d.getMode(o,"text/plain");var q={html:d.getMode(o,{name:"text/html",multilineTagIndentFactor:2,multilineTagIndentPastTag:false}),attributes:l,text:l,uri:l,css:d.getMode(o,"text/css"),js:d.getMode(o,{name:"text/javascript",statementIndent:2*o.indentUnit})};function b(e){return e[e.length-1]}function r(g,h,i){if(g.sol()){for(var e=0;e<h.indent;e++){if(!g.eat(/\s/)){break}}if(e){return null}}var k=g.string;var j=i.exec(k.substr(g.pos));if(j){g.string=k.substr(0,g.pos+j.index)}var f=g.hideFirstChars(h.indent,function(){var t=b(h.localStates);return t.mode.token(g,t.state)});g.string=k;return f}function n(e,f){while(e){if(e.element===f){return true}e=e.next}return false}function a(e,f){return{element:f,next:e}}function p(e,f,g){return n(e,f)?"variable-2":(g?"variable":"variable-2 error")}function m(e){if(e.scopes){e.variables=e.scopes.element;e.scopes=e.scopes.next}}return{startState:function(){return{kind:[],kindTag:[],soyState:[],templates:null,variables:null,scopes:null,indent:0,quoteKind:null,localStates:[{mode:q.html,state:d.startState(q.html)}]}},copyState:function(e){return{tag:e.tag,kind:e.kind.concat([]),kindTag:e.kindTag.concat([]),soyState:e.soyState.concat([]),templates:e.templates,variables:e.variables,scopes:e.scopes,indent:e.indent,quoteKind:e.quoteKind,localStates:e.localStates.map(function(f){return{mode:f.mode,state:d.copyState(f.mode,f.state)}})}},token:function(g,i){var e;switch(b(i.soyState)){case"comment":if(g.match(/^.*?\*\//)){i.soyState.pop()}else{g.skipToEnd()}return"comment";case"templ-def":if(e=g.match(/^\.?([\w]+(?!\.[\w]+)*)/)){i.templates=a(i.templates,e[1]);i.scopes=a(i.scopes,i.variables);i.soyState.pop();return"def"}g.next();return null;case"templ-ref":if(e=g.match(/^\.?([\w]+)/)){i.soyState.pop();if(e[0][0]=="."){return p(i.templates,e[1],true)}return"variable"}g.next();return null;case"param-def":if(e=g.match(/^\w+/)){i.variables=a(i.variables,e[0]);i.soyState.pop();i.soyState.push("param-type");return"def"}g.next();return null;case"param-type":if(g.peek()=="}"){i.soyState.pop();return null}if(g.eatWhile(/^[\w]+/)){return"variable-3"}g.next();return null;case"var-def":if(e=g.match(/^\$([\w]+)/)){i.variables=a(i.variables,e[1]);i.soyState.pop();return"def"}g.next();return null;case"tag":if(g.match(/^\/?}/)){if(i.tag=="/template"||i.tag=="/deltemplate"){m(i);i.indent=0}else{if(i.tag=="/for"||i.tag=="/foreach"){m(i)}i.indent-=o.indentUnit*(g.current()=="/}"||c.indexOf(i.tag)==-1?2:1)}i.soyState.pop();return"keyword"}else{if(g.match(/^([\w?]+)(?==)/)){if(g.current()=="kind"&&(e=g.match(/^="([^"]+)/,false))){var j=e[1];i.kind.push(j);i.kindTag.push(i.tag);var h=q[j]||q.html;var f=b(i.localStates);if(f.mode.indent){i.indent+=f.mode.indent(f.state,"")}i.localStates.push({mode:h,state:d.startState(h)})}return"attribute"}else{if(e=g.match(/^["']/)){i.soyState.push("string");i.quoteKind=e;return"string"}}}if(e=g.match(/^\$([\w]+)/)){return p(i.variables,e[1])}if(e=g.match(/^\w+/)){return/^(?:as|and|or|not|in)$/.test(e[0])?"keyword":null}g.next();return null;case"literal":if(g.match(/^(?=\{\/literal})/)){i.indent-=o.indentUnit;i.soyState.pop();return this.token(g,i)}return r(g,i,/\{\/literal}/);case"string":var e=g.match(/^.*?(["']|\\[\s\S])/);if(!e){g.skipToEnd()}else{if(e[1]==i.quoteKind){i.quoteKind=null;i.soyState.pop()}}return"string"}if(g.match(/^\/\*/)){i.soyState.push("comment");return"comment"}else{if(g.match(g.sol()?/^\s*\/\/.*/:/^\s+\/\/.*/)){return"comment"}else{if(g.match(/^\{literal}/)){i.indent+=o.indentUnit;i.soyState.push("literal");return"keyword"}else{if(e=g.match(/^\{([\/@\\]?\w+\??)(?=[\s\}])/)){if(e[1]!="/switch"){i.indent+=(/^(\/|(else|elseif|ifempty|case|fallbackmsg|default)$)/.test(e[1])&&i.tag!="switch"?1:2)*o.indentUnit}i.tag=e[1];if(i.tag=="/"+b(i.kindTag)){i.kind.pop();i.kindTag.pop();i.localStates.pop();var f=b(i.localStates);if(f.mode.indent){i.indent-=f.mode.indent(f.state,"")}}i.soyState.push("tag");if(i.tag=="template"||i.tag=="deltemplate"){i.soyState.push("templ-def")}if(i.tag=="call"||i.tag=="delcall"){i.soyState.push("templ-ref")}if(i.tag=="let"){i.soyState.push("var-def")}if(i.tag=="for"||i.tag=="foreach"){i.scopes=a(i.scopes,i.variables);i.soyState.push("var-def")}if(i.tag.match(/^@(?:param\??|inject)/)){i.soyState.push("param-def")}return"keyword"}else{if(g.eat("{")){i.tag="print";i.indent+=2*o.indentUnit;i.soyState.push("tag");return"keyword"}}}}}return r(g,i,/\{|\s+\/\/|\/\*/)},indent:function(h,i){var f=h.indent,g=b(h.soyState);if(g=="comment"){return d.Pass}if(g=="literal"){if(/^\{\/literal}/.test(i)){f-=o.indentUnit}}else{if(/^\s*\{\/(template|deltemplate)\b/.test(i)){return 0}if(/^\{(\/|(fallbackmsg|elseif|else|ifempty)\b)/.test(i)){f-=o.indentUnit}if(h.tag!="switch"&&/^\{(case|default)\b/.test(i)){f-=o.indentUnit}if(/^\{\/switch\b/.test(i)){f-=o.indentUnit}}var e=b(h.localStates);if(f&&e.mode.indent){f+=e.mode.indent(e.state,i)}return f},innerMode:function(e){if(e.soyState.length&&b(e.soyState)!="literal"){return null}else{return b(e.localStates)}},electricInput:/^\s*\{(\/|\/template|\/deltemplate|\/switch|fallbackmsg|elseif|else|case|default|ifempty|\/literal\})$/,lineComment:"//",blockCommentStart:"/*",blockCommentEnd:"*/",blockCommentContinue:" * ",useInnerComments:false,fold:"indent"}},"htmlmixed");d.registerHelper("hintWords","soy",c.concat(["delpackage","namespace","alias","print","css","debugger"]));d.defineMIME("text/x-soy","soy")});