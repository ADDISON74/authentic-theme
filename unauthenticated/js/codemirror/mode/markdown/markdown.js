(function(b){if(typeof exports=="object"&&typeof module=="object"){b(require("../../lib/codemirror"),require("../xml/xml"),require("../meta"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror","../xml/xml","../meta"],b)}else{b(CodeMirror)}}})(function(b){b.defineMode("markdown",function(R,aa){var af=b.getMode(R,"text/html");var al=af.name=="null";function aj(e){if(b.findModeByName){var d=b.findModeByName(e);if(d){e=d.mime||d.mimes[0]}}var c=b.getMode(R,e);return c.name=="null"?null:c}if(aa.highlightFormatting===undefined){aa.highlightFormatting=false}if(aa.maxBlockquoteDepth===undefined){aa.maxBlockquoteDepth=0}if(aa.taskLists===undefined){aa.taskLists=false}if(aa.strikethrough===undefined){aa.strikethrough=false}if(aa.tokenTypeOverrides===undefined){aa.tokenTypeOverrides={}}var X={header:"header",code:"comment",quote:"quote",list1:"variable-2",list2:"variable-3",list3:"keyword",hr:"hr",image:"image",imageAltText:"image-alt-text",imageMarker:"image-marker",formatting:"formatting",linkInline:"link",linkEmail:"link",linkText:"link",linkHref:"string",em:"em",strong:"strong",strikethrough:"strikethrough"};for(var M in X){if(X.hasOwnProperty(M)&&aa.tokenTypeOverrides[M]){X[M]=aa.tokenTypeOverrides[M]}}var L=/^([*\-_])(?:\s*\1){2,}\s*$/,a=/^(?:[*\-+]|^[0-9]+([.)]))\s+/,W=/^\[(x| )\](?=\s)/,Z=aa.allowAtxHeaderWithoutSpace?/^(#+)/:/^(#+)(?: |$)/,T=/^ *(?:\={1,}|-{1,})\s*$/,ah=/^[^#!\[\]*_\\<>` "'(~]+/,V=new RegExp("^("+(aa.fencedCodeBlocks===true?"~~~+|```+":aa.fencedCodeBlocks)+")[ \\t]*([\\w+#-]*)"),ad=/[!\"#$%&\'()*+,\-\.\/:;<=>?@\[\\\]^_`{|}~â€”]/;function ai(c,d,e){d.f=d.inline=e;return e(c,d)}function N(c,d,e){d.f=d.block=e;return e(c,d)}function Q(c){return !c||!/\S/.test(c.string)}function S(c){c.linkTitle=false;c.em=false;c.strong=false;c.strikethrough=false;c.quote=0;c.indentedCode=false;if(c.f==I){c.f=P;c.block=ab}c.trailingSpace=0;c.trailingSpaceNewLine=false;c.prevLine=c.thisLine;c.thisLine=null;return null}function ab(g,h){var i=g.sol();var d=h.list!==false,f=h.indentedCode;h.indentedCode=false;if(d){if(h.indentationDiff>=0){if(h.indentationDiff<4){h.indentation-=h.indentationDiff}h.list=null}else{if(h.indentation>0){h.list=null}else{h.list=false}}}var e=null;if(h.indentationDiff>=4){g.skipToEnd();if(f||Q(h.prevLine)){h.indentation-=4;h.indentedCode=true;return X.code}else{return null}}else{if(g.eatSpace()){return null}else{if((e=g.match(Z))&&e[1].length<=6){h.header=e[1].length;if(aa.highlightFormatting){h.formatting="header"}h.f=h.inline;return J(h)}else{if(!Q(h.prevLine)&&!h.quote&&!d&&!f&&(e=g.match(T))){h.header=e[0].charAt(0)=="="?1:2;if(aa.highlightFormatting){h.formatting="header"}h.f=h.inline;return J(h)}else{if(g.eat(">")){h.quote=i?1:h.quote+1;if(aa.highlightFormatting){h.formatting="quote"}g.eatSpace();return J(h)}else{if(g.peek()==="["){return ai(g,h,ac)}else{if(g.match(L,true)){h.hr=true;return X.hr}else{if(e=g.match(a)){var c=e[1]?"ol":"ul";h.indentation=g.column()+g.current().length;h.list=true;while(h.listStack&&g.column()<h.listStack[h.listStack.length-1]){h.listStack.pop()}h.listStack.push(h.indentation);if(aa.taskLists&&g.match(W,false)){h.taskList=true}h.f=h.inline;if(aa.highlightFormatting){h.formatting=["list","list-"+c]}return J(h)}else{if(aa.fencedCodeBlocks&&(e=g.match(V,true))){h.fencedChars=e[1];h.localMode=aj(e[2]);if(h.localMode){h.localState=b.startState(h.localMode)}h.f=h.block=K;if(aa.highlightFormatting){h.formatting="code-block"}h.code=-1;return J(h)}}}}}}}}}return ai(g,h,h.inline)}function I(c,d){var e=af.token(c,d.htmlState);if(!al){var f=b.innerMode(af,d.htmlState);if((f.mode.name=="xml"&&f.state.tagStart===null&&(!f.state.context&&f.state.tokenize.isInText))||(d.md_inside&&c.current().indexOf(">")>-1)){d.f=P;d.block=ab;d.htmlState=null}}return e}function K(c,d){if(d.fencedChars&&c.match(d.fencedChars)){if(aa.highlightFormatting){d.formatting="code-block"}var e=J(d);d.localMode=d.localState=null;d.block=ab;d.f=P;d.fencedChars=null;d.code=0;return e}else{if(d.fencedChars&&c.skipTo(d.fencedChars)){return"comment"}else{if(d.localMode){return d.localMode.token(c,d.localState)}else{c.skipToEnd();return X.code}}}}function J(c){var d=[];if(c.formatting){d.push(X.formatting);if(typeof c.formatting==="string"){c.formatting=[c.formatting]}for(var f=0;f<c.formatting.length;f++){d.push(X.formatting+"-"+c.formatting[f]);if(c.formatting[f]==="header"){d.push(X.formatting+"-"+c.formatting[f]+"-"+c.header)}if(c.formatting[f]==="quote"){if(!aa.maxBlockquoteDepth||aa.maxBlockquoteDepth>=c.quote){d.push(X.formatting+"-"+c.formatting[f]+"-"+c.quote)}else{d.push("error")}}}}if(c.taskOpen){d.push("meta");return d.length?d.join(" "):null}if(c.taskClosed){d.push("property");return d.length?d.join(" "):null}if(c.linkHref){d.push(X.linkHref,"url")}else{if(c.strong){d.push(X.strong)}if(c.em){d.push(X.em)}if(c.strikethrough){d.push(X.strikethrough)}if(c.linkText){d.push(X.linkText)}if(c.code){d.push(X.code)}if(c.image){d.push(X.image)}if(c.imageAltText){d.push(X.imageAltText,"link")}if(c.imageMarker){d.push(X.imageMarker)}}if(c.header){d.push(X.header,X.header+"-"+c.header)}if(c.quote){d.push(X.quote);if(!aa.maxBlockquoteDepth||aa.maxBlockquoteDepth>=c.quote){d.push(X.quote+"-"+c.quote)}else{d.push(X.quote+"-"+aa.maxBlockquoteDepth)}}if(c.list!==false){var e=(c.listStack.length-1)%3;if(!e){d.push(X.list1)}else{if(e===1){d.push(X.list2)}else{d.push(X.list3)}}}if(c.trailingSpaceNewLine){d.push("trailing-space-new-line")}else{if(c.trailingSpace){d.push("trailing-space-"+(c.trailingSpace%2?"a":"b"))}}return d.length?d.join(" "):null}function am(c,d){if(c.match(ah,true)){return J(d)}return undefined}function P(n,o){var v=o.text(n,o);if(typeof v!=="undefined"){return v}if(o.list){o.list=null;return J(o)}if(o.taskList){var f=n.match(W,true)[1]!=="x";if(f){o.taskOpen=true}else{o.taskClosed=true}if(aa.highlightFormatting){o.formatting="task"}o.taskList=false;return J(o)}o.taskOpen=false;o.taskClosed=false;if(o.header&&n.match(/^#+$/,true)){if(aa.highlightFormatting){o.formatting="header"}return J(o)}var j=n.next();if(o.linkTitle){o.linkTitle=false;var c=j;if(j==="("){c=")"}c=(c+"").replace(/([.?*+^\[\]\\(){}|-])/g,"\\$1");var r="^\\s*(?:[^"+c+"\\\\]+|\\\\\\\\|\\\\.)"+c;if(n.match(new RegExp(r),true)){return X.linkHref}}if(j==="`"){var d=o.formatting;if(aa.highlightFormatting){o.formatting="code"}n.eatWhile("`");var m=n.current().length;if(o.code==0){o.code=m;return J(o)}else{if(m==o.code){var h=J(o);o.code=0;return h}else{o.formatting=d;return J(o)}}}else{if(o.code){return J(o)}}if(j==="\\"){n.next();if(aa.highlightFormatting){var q=J(o);var k=X.formatting+"-escape";return q?q+" "+k:k}}if(j==="!"&&n.match(/\[[^\]]*\] ?(?:\(|\[)/,false)){o.imageMarker=true;o.image=true;if(aa.highlightFormatting){o.formatting="image"}return J(o)}if(j==="["&&o.imageMarker&&n.match(/[^\]]*\](\(.*?\)| ?\[.*?\])/,false)){o.imageMarker=false;o.imageAltText=true;if(aa.highlightFormatting){o.formatting="image"}return J(o)}if(j==="]"&&o.imageAltText){if(aa.highlightFormatting){o.formatting="image"}var q=J(o);o.imageAltText=false;o.image=false;o.inline=o.f=ag;return q}if(j==="["&&!o.image){o.linkText=true;if(aa.highlightFormatting){o.formatting="link"}return J(o)}if(j==="]"&&o.linkText){if(aa.highlightFormatting){o.formatting="link"}var q=J(o);o.linkText=false;o.inline=o.f=n.match(/\(.*?\)| ?\[.*?\]/,false)?ag:P;return q}if(j==="<"&&n.match(/^(https?|ftps?):\/\/(?:[^\\>]|\\.)+>/,false)){o.f=o.inline=Y;if(aa.highlightFormatting){o.formatting="link"}var q=J(o);if(q){q+=" "}else{q=""}return q+X.linkInline}if(j==="<"&&n.match(/^[^> \\]+@(?:[^\\>]|\\.)+>/,false)){o.f=o.inline=Y;if(aa.highlightFormatting){o.formatting="link"}var q=J(o);if(q){q+=" "}else{q=""}return q+X.linkEmail}if(j==="<"&&n.match(/^(!--|[a-z]+(?:\s+[a-z_:.\-]+(?:\s*=\s*[^ >]+)?)*\s*>)/i,false)){var p=n.string.indexOf(">",n.pos);if(p!=-1){var e=n.string.substring(n.start,p);if(/markdown\s*=\s*('|"){0,1}1('|"){0,1}/.test(e)){o.md_inside=true}}n.backUp(1);o.htmlState=b.startState(af);return N(n,o,I)}if(j==="<"&&n.match(/^\/\w*?>/)){o.md_inside=false;return"tag"}else{if(j==="*"||j==="_"){var w=1,g=n.pos==1?" ":n.string.charAt(n.pos-2);while(w<3&&n.eat(j)){w++}var s=n.peek()||" ";var i=!/\s/.test(s)&&(!ad.test(s)||/\s/.test(g)||ad.test(g));var u=!/\s/.test(g)&&(!ad.test(g)||/\s/.test(s)||ad.test(s));var l=null,t=null;if(w%2){if(!o.em&&i&&(j==="*"||!u||ad.test(g))){l=true}else{if(o.em==j&&u&&(j==="*"||!i||ad.test(s))){l=false}}}if(w>1){if(!o.strong&&i&&(j==="*"||!u||ad.test(g))){t=true}else{if(o.strong==j&&u&&(j==="*"||!i||ad.test(s))){t=false}}}if(t!=null||l!=null){if(aa.highlightFormatting){o.formatting=l==null?"strong":t==null?"em":"strong em"}if(l===true){o.em=j}if(t===true){o.strong=j}var h=J(o);if(l===false){o.em=false}if(t===false){o.strong=false}return h}}else{if(j===" "){if(n.eat("*")||n.eat("_")){if(n.peek()===" "){return J(o)}else{n.backUp(1)}}}}}if(aa.strikethrough){if(j==="~"&&n.eatWhile(j)){if(o.strikethrough){if(aa.highlightFormatting){o.formatting="strikethrough"}var h=J(o);o.strikethrough=false;return h}else{if(n.match(/^[^\s]/,false)){o.strikethrough=true;if(aa.highlightFormatting){o.formatting="strikethrough"}return J(o)}}}else{if(j===" "){if(n.match(/^~~/,true)){if(n.peek()===" "){return J(o)}else{n.backUp(2)}}}}}if(j===" "){if(n.match(/ +$/,false)){o.trailingSpace++}else{if(o.trailingSpace){o.trailingSpaceNewLine=true}}}return J(o)}function Y(c,d){var e=c.next();if(e===">"){d.f=d.inline=P;if(aa.highlightFormatting){d.formatting="link"}var f=J(d);if(f){f+=" "}else{f=""}return f+X.linkInline}c.match(/^[^>]+/,true);return X.linkInline}function ag(c,d){if(c.eatSpace()){return null}var e=c.next();if(e==="("||e==="["){d.f=d.inline=ae(e==="("?")":"]");if(aa.highlightFormatting){d.formatting="link-string"}d.linkHref=true;return J(d)}return"error"}var ak={")":/^(?:[^\\\(\)]|\\.|\((?:[^\\\(\)]|\\.)*\))*?(?=\))/,"]":/^(?:[^\\\[\]]|\\.|\[(?:[^\\\[\]]|\\.)*\])*?(?=\])/};function ae(c){return function(g,d){var e=g.next();if(e===c){d.f=d.inline=P;if(aa.highlightFormatting){d.formatting="link-string"}var f=J(d);d.linkHref=false;return f}g.match(ak[c]);d.linkHref=true;return J(d)}}function ac(c,d){if(c.match(/^([^\]\\]|\\.)*\]:/,false)){d.f=O;c.next();if(aa.highlightFormatting){d.formatting="link"}d.linkText=true;return J(d)}return ai(c,d,P)}function O(c,d){if(c.match(/^\]:/,true)){d.f=d.inline=an;if(aa.highlightFormatting){d.formatting="link"}var e=J(d);d.linkText=false;return e}c.match(/^([^\]\\]|\\.)+/,true);return X.linkText}function an(c,d){if(c.eatSpace()){return null}c.match(/^[^\s]+/,true);if(c.peek()===undefined){d.linkTitle=true}else{c.match(/^(?:\s+(?:"(?:[^"\\]|\\\\|\\.)+"|'(?:[^'\\]|\\\\|\\.)+'|\((?:[^)\\]|\\\\|\\.)+\)))?/,true)}d.f=d.inline=P;return X.linkHref+" url"}var U={startState:function(){return{f:ab,prevLine:null,thisLine:null,block:ab,htmlState:null,indentation:0,inline:P,text:am,formatting:false,linkText:false,linkHref:false,linkTitle:false,code:0,em:false,strong:false,header:0,hr:false,taskList:false,list:false,listStack:[],quote:0,trailingSpace:0,trailingSpaceNewLine:false,strikethrough:false,fencedChars:null}},copyState:function(c){return{f:c.f,prevLine:c.prevLine,thisLine:c.thisLine,block:c.block,htmlState:c.htmlState&&b.copyState(af,c.htmlState),indentation:c.indentation,localMode:c.localMode,localState:c.localMode?b.copyState(c.localMode,c.localState):null,inline:c.inline,text:c.text,formatting:false,linkText:c.linkText,linkTitle:c.linkTitle,code:c.code,em:c.em,strong:c.strong,strikethrough:c.strikethrough,header:c.header,hr:c.hr,taskList:c.taskList,list:c.list,listStack:c.listStack.slice(0),quote:c.quote,indentedCode:c.indentedCode,trailingSpace:c.trailingSpace,trailingSpaceNewLine:c.trailingSpaceNewLine,md_inside:c.md_inside,fencedChars:c.fencedChars}},token:function(c,d){d.formatting=false;if(c!=d.thisLine){var f=d.header||d.hr;d.header=0;d.hr=false;if(c.match(/^\s*$/,true)||f){S(d);if(!f){return null}d.prevLine=null}d.prevLine=d.thisLine;d.thisLine=c;d.taskList=false;d.trailingSpace=0;d.trailingSpaceNewLine=false;d.f=d.block;var e=c.match(/^\s*/,true)[0].replace(/\t/g,"    ").length;d.indentationDiff=Math.min(e-d.indentation,4);d.indentation=d.indentation+d.indentationDiff;if(e>0){return null}}return d.f(c,d)},innerMode:function(c){if(c.block==I){return{state:c.htmlState,mode:af}}if(c.localState){return{state:c.localState,mode:c.localMode}}return{state:c,mode:U}},blankLine:S,getType:J,closeBrackets:"()[]{}''\"\"``",fold:"markdown"};return U},"xml");b.defineMIME("text/x-markdown","markdown")});